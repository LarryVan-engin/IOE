<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0"> 
    <title>H·ªá th·ªëng qu·∫£n l√Ω t√†i kho·∫£n - User Website</title>
    <style>
        /* ------------------------------ */
        /* TO√ÄN TRANG (RESET & C∆† B·∫¢N) */
        /* ------------------------------ */
        * { box-sizing: border-box; margin:0; padding:0; }
        body {
            font-family: 'Segoe UI', sans-serif;
            background-color: #f4f5f7;
            color: #333;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        /* ------------------------------ */
        /* HEADER */
        /* ------------------------------ */
        header {
            background-color: #1f2937;
            color: white;
            padding: 10px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            flex-wrap: wrap;
        }
        header .logo { font-weight: bold; font-size: 18px; }
        header .system-name { font-size: 16px; margin-left: 20px; }
        header .user-info { display: flex; align-items: center; gap: 10px; font-size: 14px; }
        .logout-btn {
        background: var(--color-error); color: var(--color-text-light); 
        border: none; border-radius: 6px;
        padding: 8px 14px; cursor: pointer; font-weight: bold; transition:0.2s;
        white-space: nowrap; 
        }
        .logout-btn:hover { background: #b02a37; }

        /* ------------------------------ */
        /* MAIN LAYOUT (3 c·ªôt) */
        /* ------------------------------ */
        .container {
            flex: 1;
            display: grid;
            grid-template-columns: 1fr 2fr 1fr;
            gap: 15px; 
            padding: 15px; 
            overflow: hidden;
        }

        /* ------------------------------ */
        /* C·ªòT CHUNG: SIDEBARS & CHAT */
        /* ------------------------------ */
        .chat-history, .chat-box, .transaction-history {
            background: white;
            border-radius: 10px; 
            padding: 15px; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
            overflow: hidden; 
        }
        h3 { margin-bottom: 15px; color: #1f2937; }

        /* L·ªäCH S·ª¨ H·ªòI THO·∫†I */
        .chat-history { overflow-y: auto; }
        .chat-item {
            border: 1px solid #e5e7eb;
            padding: 10px;
            margin: 8px 0;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9em;
            transition: background 0.2s;
        }
        .chat-item:hover { background: #f3f4f6; }

        /* KHUNG CHAT AI */
        .chat-box { 
            display: flex; flex-direction: column; 
            padding: 15px 15px 10px 15px;
        }
        .messages { flex: 1; overflow-y: auto; padding: 0 5px; } 
        .message {
            margin: 8px 0;
            max-width: 90%;
            padding: 10px;
            border-radius: 12px;
            font-size: 0.95em;
        }
        .ai { background-color: #e5e7eb; align-self: flex-start; }
        .user { background-color: #60a5fa; color: white; align-self: flex-end; }
        .chat-input { display: flex; border-top: 1px solid #eee; padding-top: 10px; margin-top: 5px; }
        .chat-input input {
            flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 8px; margin-right: 10px;
        }
        .chat-input button {
            background-color: #2563eb; color: white; border: none; padding: 10px 18px; border-radius: 8px; cursor: pointer;
            transition: background-color 0.2s;
        }
        .chat-input button:hover { background-color: #1d4ed8; }

        /* L·ªäCH S·ª¨ GIAO D·ªäCH */
        .transaction-history { overflow-y: auto; }
        table { width: 100%; border-collapse: collapse; font-size: 13px; }
        th, td { border: none; padding: 8px 5px; text-align: left; } 
        th { background-color: #f3f4f6; border-bottom: 2px solid #ddd; font-weight: 600; }
        td { border-bottom: 1px solid #eee; }
        .status { font-size: 0.9em; padding: 2px 5px; border-radius: 4px; display: inline-block; }
        .pending { background: #fffbe6; color: #f59e0b; font-weight: 600; }
        .success { background: #dcfce7; color: #16a34a; font-weight: 600; }
        .failed { background: #fee2e2; color: #dc2626; font-weight: 600; }
        .pay-btn {
            background-color: #3b82f6; color: white; border: none; padding: 6px 10px; border-radius: 4px; cursor: pointer; transition: 0.2s;
            font-size: 0.9em;
        }
        .pay-btn:hover { background-color: #2563eb; }

        /* ================= RESPONSIVE (FOR MOBILE/TABLET) ================= */
        @media (max-width: 800px) {
            header .system-name, header .user-info strong { display: none; }
            header .user-info { gap: 5px; }

            .container {
                grid-template-columns: 1fr;
                grid-template-rows: auto 2fr auto;
                height: auto;
                padding: 10px;
                gap: 10px;
            }
            
            .chat-history { order: 1; height: 150px; }
            .chat-box { order: 2; height: 60vh; max-height: 500px; }
            .transaction-history { order: 3; height: auto; }
            
            .transaction-history table { 
                display: block;
                overflow-x: auto;
                white-space: nowrap;
                width: 100%;
                min-width: 500px;
            }
        }
    </style>
</head>

<body>
    <header>
        <div class="logo">‚öôÔ∏è LOGO</div>
        <div class="system-name">H·ªá th·ªëng qu·∫£n l√Ω t√†i kho·∫£n</div>
        <div class="user-info">
            <div>
                Xin ch√†o, <strong id="fullname">Nguy·ªÖn VƒÉn A</strong> 
                <div id="phone" style="font-size: 13px; color: #ccc;">0912346789</div>
            </div>
            <button class="logout-btn" type="button" onclick="logout()">ƒêƒÉng Xu·∫•t</button>
        </div>
    </header>

    <div class="container">
        <div class="chat-history">
            <h3>L·ªãch s·ª≠ h·ªôi tho·∫°i</h3>
            <div class="chat-item">H·ªôi tho·∫°i #1 - 12/10/2025</div>
            <div class="chat-item">H·ªôi tho·∫°i #2 - 14/10/2025</div>
            <div class="chat-item">H·ªôi tho·∫°i #3 - 16/10/2025</div>
        </div>

        <div class="chat-box">
            <h3>Khung chat AI</h3>
            <div class="messages">
                <div class="message ai">Xin ch√†o! T√¥i l√† tr·ª£ l√Ω AI, b·∫°n c·∫ßn h·ªó tr·ª£ g√¨?</div>
                <div class="message user">T√¥i mu·ªën xem g√≥i d·ªãch v·ª• c·ªßa m√¨nh.</div>
                <div class="message ai">G√≥i hi·ªán t·∫°i: Premium, h·∫øt h·∫°n v√†o 31/12/2025.</div>
                <div class="message user">L√†m sao ƒë·ªÉ thanh to√°n ƒë∆°n h√†ng #002?</div>
                <div class="message ai">B·∫°n c√≥ th·ªÉ b·∫•m v√†o n√∫t **Thanh to√°n** ·ªü c·ªôt L·ªãch s·ª≠ giao d·ªãch ho·∫∑c n√≥i chuy·ªán v·ªõi b·ªô ph·∫≠n h·ªó tr·ª£.</div>
            </div>
            <div class="chat-input">
                <input type="text" placeholder="Nh·∫≠p tin nh·∫Øn...">
                <button>G·ª≠i</button>
            </div>
        </div>

        <div id="products"></div>


        <div class="transaction-history">
            <h3>L·ªãch s·ª≠ giao d·ªãch</h3>
            <table>
                <tr>
                    <th>M√£ GD</th>
                    <th>Th·ªùi gian</th>
                    <th>G√≥i</th>
                    <th>Tr·∫°ng th√°i</th>
                    <th>H√†nh ƒë·ªông</th>
                </tr>
                <tr>
                    <td>#001</td>
                    <td>10/10/2025</td>
                    <td>Basic</td>
                    <td><span class="status success">Th√†nh c√¥ng</span></td>
                    <td>-</td>
                </tr>
                <tr>
                    <td>#002</td>
                    <td>14/10/2025</td>
                    <td>Pro</td>
                    <td><span class="status pending">Ch·ªù thanh to√°n</span></td>
                    <td><a href="payment.html"><button class="pay-btn">Thanh to√°n</button></a></td>
                </tr>
                <tr>
                    <td>#003</td>
                    <td>16/10/2025</td>
                    <td>Premium</td>
                    <td><span class="status failed">Th·∫•t b·∫°i</span></td>
                    <td>-</td>
                </tr>
            </table>
        </div>
    </div>
    <script src="js/auth.js"></script>
    <script>
        const PRODUCTS = [
            { productId: "p1", name: "G√≥i Basic", price: 100000 },
            { productId: "p2", name: "G√≥i Pro", price: 300000 },
            { productId: "p3", name: "G√≥i Premium", price: 500000 }
            ];

        function renderProducts(){
        const el = document.getElementById("products");
        el.innerHTML = PRODUCTS.map(p => `
            <div style="padding:10px;background:white;margin:8px;border-radius:8px;">
            <h4>${p.name}</h4>
            <p>Gi√°: ${p.price} VNƒê</p>
            <button onclick='buy("${p.productId}")'>Mua</button>
            </div>
        `).join("");
        }

        async function buy(productId){
        const product = PRODUCTS.find(p => p.productId === productId);
        // t·∫°o order backend
        const res = await fetch("http://localhost:8000/v1/orders", {
            method: "POST",
            headers: {
            "Content-Type": "application/json",
            "Authorization": "Bearer " + localStorage.getItem("accessToken")
            },
            credentials: "include",
            body: JSON.stringify({ items:[{productId: product.productId, name: product.name, price: product.price, quantity:1}] })
        });
        const data = await res.json();
        if(res.ok){
            // redirect ƒë·∫øn trang payment, k√®m orderId trong query
            window.location.href = `payment.html?orderId=${data.order._id}`;
        } else {
            alert(data.message || "Kh√¥ng th·ªÉ t·∫°o ƒë∆°n h√†ng");
        }
        }

        async function loadUserInfo() {
            // L·∫•y token t·ª´ Local Storage
            const accessToken = localStorage.getItem('accessToken');
            if (!accessToken) {

                // ƒê·∫£m b·∫£o kh√¥ng alert/redirect ngay l·∫≠p t·ª©c n·∫øu script ƒë∆∞·ª£c t·∫£i s·ªõm
                console.log("Ng∆∞·ªùi d√πng ch∆∞a ƒëƒÉng nh·∫≠p.");
               // window.location.href = "./login.html"; // C√≥ th·ªÉ gi·ªØ l·∫°i n·∫øu b·∫°n mu·ªën b·∫£o v·ªá trang ngay l·∫≠p t·ª©c
                return;
            }

            try {
                // Th·ª±c hi·ªán fetch ƒë·∫øn endpoint user info
                const res = await fetch(API_BASE + "/v1/user", {
                    method: 'GET',
                    credentials: 'include', // Gi·ªØ l·∫°i n·∫øu b·∫°n mu·ªën g·ª≠i c·∫£ cookie (nh∆∞ refresh token)
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": "Bearer " + accessToken //  g·ª≠i accessToken
                    }
                });

                if (!res.ok) throw new Error('L·ªói x√°c th·ª±c ho·∫∑c phi√™n h·∫øt h·∫°n');
                
                if (res.status === 401) {
                    //Token h·∫øt h·∫°n ‚Üí t·ª± ƒë·ªông refresh
                    const refreshed = await refreshAccessToken();
                    if (refreshed) {
                        return await loadUserInfo(); // G·ªçi l·∫°i ch√≠nh h√†m n√†y sau khi refresh xong
                    } else {
                        alert("Phi√™n ƒëƒÉng nh·∫≠p h·∫øt h·∫°n, vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i!!!");
                        window.location.href = "./login.html";
                        return;
                    }
                }

                const user = await res.json();
                console.log("Thong tin user: ", user);

                // C·∫≠p nh·∫≠t t√™n ng∆∞·ªùi d√πng
                document.getElementById('fullname').innerText = user.fullname || user.username; 
                document.getElementById('phone').innerText = user.phone ? `üìû ${user.phone}` : 'Ch∆∞a c√≥ s·ªë ƒëi·ªán tho·∫°i'; 
            } catch (err) {
                console.log(token);
                console.log(err);
                console.error("L·ªói t·∫£i th√¥ng tin user:", err);
                // N·∫øu l·ªói, gi·∫£ ƒë·ªãnh phi√™n h·∫øt h·∫°n
                alert("Phi√™n ƒëƒÉng nh·∫≠p h·∫øt h·∫°n, vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i!");
                
                localStorage.removeItem('accessToken'); // X√≥a token c≈©
                window.location.href = "./login.html";  
            }
        }
        // T·∫£i th√¥ng tin ng∆∞·ªùi d√πng sau khi DOM ƒë√£ ƒë∆∞·ª£c t·∫£i ho√†n ch·ªânh
        window.addEventListener("DOMContentLoaded", () => {
        renderProducts(); loadUserInfo()
    });
    </script>

</body>
</html>