<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0"> 
    <title>Hệ thống quản lý tài khoản - User Website</title>
    <style>
        /* ------------------------------ */
        /* TOÀN TRANG (RESET & CƠ BẢN) */
        /* ------------------------------ */
        * { box-sizing: border-box; margin:0; padding:0; }
        body {
            font-family: 'Segoe UI', sans-serif;
            background-color: #f4f5f7;
            color: #333;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        /* ------------------------------ */
        /* HEADER */
        /* ------------------------------ */
        header {
            background-color: #1f2937;
            color: white;
            padding: 10px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            flex-wrap: wrap;
        }
        header .logo { font-weight: bold; font-size: 18px; }
        header .system-name { font-size: 16px; margin-left: 20px; }
        header .user-info { display: flex; align-items: center; gap: 10px; font-size: 14px; }
        .logout-btn {
        background: var(--color-error); color: var(--color-text-light); 
        border: none; border-radius: 6px;
        padding: 8px 14px; cursor: pointer; font-weight: bold; transition:0.2s;
        white-space: nowrap; 
        }
        .logout-btn:hover { background: #b02a37; }

        /* ------------------------------ */
        /* MAIN LAYOUT (3 cột) */
        /* ------------------------------ */
        .container {
            flex: 1;
            display: grid;
            grid-template-columns: 1fr 2fr 1fr;
            gap: 15px; 
            padding: 15px; 
            overflow: hidden;
        }

        /* ------------------------------ */
        /* CỘT CHUNG: SIDEBARS & CHAT */
        /* ------------------------------ */
        .chat-history, .chat-box, .transaction-history {
            background: white;
            border-radius: 10px; 
            padding: 15px; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
            overflow: hidden; 
        }
        h3 { margin-bottom: 15px; color: #1f2937; }

        /* LỊCH SỬ HỘI THOẠI */
        .chat-history { overflow-y: auto; }
        .chat-item {
            border: 1px solid #e5e7eb;
            padding: 10px;
            margin: 8px 0;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9em;
            transition: background 0.2s;
        }
        .chat-item:hover { background: #f3f4f6; }

        /* KHUNG CHAT AI */
        .chat-box { 
            display: flex; flex-direction: column; 
            padding: 15px 15px 10px 15px;
        }
        .messages { flex: 1; overflow-y: auto; padding: 0 5px; } 
        .message {
            margin: 8px 0;
            max-width: 90%;
            padding: 10px;
            border-radius: 12px;
            font-size: 0.95em;
        }
        .ai { background-color: #e5e7eb; align-self: flex-start; }
        .user { background-color: #60a5fa; color: white; align-self: flex-end; }
        .chat-input { display: flex; border-top: 1px solid #eee; padding-top: 10px; margin-top: 5px; }
        .chat-input input {
            flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 8px; margin-right: 10px;
        }
        .chat-input button {
            background-color: #2563eb; color: white; border: none; padding: 10px 18px; border-radius: 8px; cursor: pointer;
            transition: background-color 0.2s;
        }
        .chat-input button:hover { background-color: #1d4ed8; }

        /* LỊCH SỬ GIAO DỊCH */
        .transaction-history { overflow-y: auto; }
        table { width: 100%; border-collapse: collapse; font-size: 13px; }
        th, td { border: none; padding: 8px 5px; text-align: left; } 
        th { background-color: #f3f4f6; border-bottom: 2px solid #ddd; font-weight: 600; }
        td { border-bottom: 1px solid #eee; }
        .status { font-size: 0.9em; padding: 2px 5px; border-radius: 4px; display: inline-block; }
        .pending { background: #fffbe6; color: #f59e0b; font-weight: 600; }
        .success { background: #dcfce7; color: #16a34a; font-weight: 600; }
        .failed { background: #fee2e2; color: #dc2626; font-weight: 600; }
        .pay-btn {
            background-color: #3b82f6; color: white; border: none; padding: 6px 10px; border-radius: 4px; cursor: pointer; transition: 0.2s;
            font-size: 0.9em;
        }
        .pay-btn:hover { background-color: #2563eb; }

        /* ================= RESPONSIVE (FOR MOBILE/TABLET) ================= */
        @media (max-width: 800px) {
            header .system-name, header .user-info strong { display: none; }
            header .user-info { gap: 5px; }

            .container {
                grid-template-columns: 1fr;
                grid-template-rows: auto 2fr auto;
                height: auto;
                padding: 10px;
                gap: 10px;
            }
            
            .chat-history { order: 1; height: 150px; }
            .chat-box { order: 2; height: 60vh; max-height: 500px; }
            .transaction-history { order: 3; height: auto; }
            
            .transaction-history table { 
                display: block;
                overflow-x: auto;
                white-space: nowrap;
                width: 100%;
                min-width: 500px;
            }
        }
    </style>
</head>

<body>
    <header>
        <div class="logo">⚙️ LOGO</div>
        <div class="system-name">Hệ thống quản lý tài khoản</div>
        <div class="user-info">
            <div>
                Xin chào, <strong id="fullname">Nguyễn Văn A</strong> 
                <div id="phone" style="font-size: 13px; color: #ccc;">0912346789</div>
            </div>
            <button class="logout-btn" type="button" onclick="logout()">Đăng Xuất</button>
        </div>
    </header>

    <div class="container">
        <div class="chat-history">
            <h3>Lịch sử hội thoại</h3>
            <div class="chat-item">Hội thoại #1 - 12/10/2025</div>
            <div class="chat-item">Hội thoại #2 - 14/10/2025</div>
            <div class="chat-item">Hội thoại #3 - 16/10/2025</div>
        </div>

        <div class="chat-box">
            <h3>Khung chat AI</h3>
            <div class="messages">
                <div class="message ai">Xin chào! Tôi là trợ lý AI, bạn cần hỗ trợ gì?</div>
                <div class="message user">Tôi muốn xem gói dịch vụ của mình.</div>
                <div class="message ai">Gói hiện tại: Premium, hết hạn vào 31/12/2025.</div>
                <div class="message user">Làm sao để thanh toán đơn hàng #002?</div>
                <div class="message ai">Bạn có thể bấm vào nút **Thanh toán** ở cột Lịch sử giao dịch hoặc nói chuyện với bộ phận hỗ trợ.</div>
            </div>
            <div class="chat-input">
                <input type="text" placeholder="Nhập tin nhắn...">
                <button>Gửi</button>
            </div>
        </div>

        <div id="products"></div>


        <div class="transaction-history">
            <h3>Lịch sử giao dịch</h3>
            <table>
                <tr>
                    <th>Mã GD</th>
                    <th>Thời gian</th>
                    <th>Gói</th>
                    <th>Trạng thái</th>
                    <th>Hành động</th>
                </tr>
                <tr>
                    <td>#001</td>
                    <td>10/10/2025</td>
                    <td>Basic</td>
                    <td><span class="status success">Thành công</span></td>
                    <td>-</td>
                </tr>
                <tr>
                    <td>#002</td>
                    <td>14/10/2025</td>
                    <td>Pro</td>
                    <td><span class="status pending">Chờ thanh toán</span></td>
                    <td><a href="payment.html"><button class="pay-btn">Thanh toán</button></a></td>
                </tr>
                <tr>
                    <td>#003</td>
                    <td>16/10/2025</td>
                    <td>Premium</td>
                    <td><span class="status failed">Thất bại</span></td>
                    <td>-</td>
                </tr>
            </table>
        </div>
    </div>
    <script src="js/auth.js"></script>
    <script>
        const PRODUCTS = [
            { productId: "p1", name: "Gói Basic", price: 100000 },
            { productId: "p2", name: "Gói Pro", price: 300000 },
            { productId: "p3", name: "Gói Premium", price: 500000 }
            ];

        function renderProducts(){
        const el = document.getElementById("products");
        el.innerHTML = PRODUCTS.map(p => `
            <div style="padding:10px;background:white;margin:8px;border-radius:8px;">
            <h4>${p.name}</h4>
            <p>Giá: ${p.price} VNĐ</p>
            <button onclick='buy("${p.productId}")'>Mua</button>
            </div>
        `).join("");
        }

        async function buy(productId){
        const product = PRODUCTS.find(p => p.productId === productId);
        // tạo order backend
        const res = await fetch("http://localhost:8000/v1/orders", {
            method: "POST",
            headers: {
            "Content-Type": "application/json",
            "Authorization": "Bearer " + localStorage.getItem("accessToken")
            },
            credentials: "include",
            body: JSON.stringify({ items:[{productId: product.productId, name: product.name, price: product.price, quantity:1}] })
        });
        const data = await res.json();
        if(res.ok){
            // redirect đến trang payment, kèm orderId trong query
            window.location.href = `payment.html?orderId=${data.order._id}`;
        } else {
            alert(data.message || "Không thể tạo đơn hàng");
        }
        }

        async function loadUserInfo() {
            // Lấy token từ Local Storage
            const accessToken = localStorage.getItem('accessToken');
            if (!accessToken) {

                // Đảm bảo không alert/redirect ngay lập tức nếu script được tải sớm
                console.log("Người dùng chưa đăng nhập.");
               // window.location.href = "./login.html"; // Có thể giữ lại nếu bạn muốn bảo vệ trang ngay lập tức
                return;
            }

            try {
                // Thực hiện fetch đến endpoint user info
                const res = await fetch(API_BASE + "/v1/user", {
                    method: 'GET',
                    credentials: 'include', // Giữ lại nếu bạn muốn gửi cả cookie (như refresh token)
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": "Bearer " + accessToken //  gửi accessToken
                    }
                });

                if (!res.ok) throw new Error('Lỗi xác thực hoặc phiên hết hạn');
                
                if (res.status === 401) {
                    //Token hết hạn → tự động refresh
                    const refreshed = await refreshAccessToken();
                    if (refreshed) {
                        return await loadUserInfo(); // Gọi lại chính hàm này sau khi refresh xong
                    } else {
                        alert("Phiên đăng nhập hết hạn, vui lòng đăng nhập lại!!!");
                        window.location.href = "./login.html";
                        return;
                    }
                }

                const user = await res.json();
                console.log("Thong tin user: ", user);

                // Cập nhật tên người dùng
                document.getElementById('fullname').innerText = user.fullname || user.username; 
                document.getElementById('phone').innerText = user.phone ? `📞 ${user.phone}` : 'Chưa có số điện thoại'; 
            } catch (err) {
                console.log(token);
                console.log(err);
                console.error("Lỗi tải thông tin user:", err);
                // Nếu lỗi, giả định phiên hết hạn
                alert("Phiên đăng nhập hết hạn, vui lòng đăng nhập lại!");
                
                localStorage.removeItem('accessToken'); // Xóa token cũ
                window.location.href = "./login.html";  
            }
        }
        // Tải thông tin người dùng sau khi DOM đã được tải hoàn chỉnh
        window.addEventListener("DOMContentLoaded", () => {
        renderProducts(); loadUserInfo()
    });
    </script>

</body>
</html>