<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Quản lý Thanh toán - Admin</title>
  <style>
    :root {
      --color-primary-dark: #2b3a55;
      --color-error: #dc3545;
      --color-text-light: white;
      --color-bg-light: #f5f6fa;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: "Segoe UI", sans-serif;
      background: var(--color-bg-light);
      min-height: 100vh;
    }
    .header {
      display: flex; justify-content: space-between; align-items: center;
      background: var(--color-primary-dark); color: var(--color-text-light);
      padding: 15px 30px;
      height: 60px; box-shadow: 0 2px 8px rgba(0,0,0,0.3);
      margin-bottom: 20px;
    }
    .logo a {
      font-weight: bold; font-size: 1.1em;
      color: white; text-decoration: none;
    }
    .title { font-size: 16px; margin-left: 15px; display: inline-block; }
    .user-info { display: flex; align-items: center; gap: 15px; }
    .user-info span { font-size: 0.9em; }
    .logout-btn {
      background: var(--color-error); color: var(--color-text-light);
      border: none; border-radius: 6px;
      padding: 8px 14px; cursor: pointer; font-weight: bold;
      white-space: nowrap;
    }
    .logout-btn:hover { background: #b02a37; }

    .main-content { padding: 0 30px; }
    h2 { color: var(--color-primary-dark); margin-bottom: 20px; }
    .table-container { overflow-x: auto; }

    table {
      min-width: 700px; width: 100%;
      border-collapse: collapse;
      background: white;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    }
    th, td {
      padding: 12px; text-align: left; border-bottom: 1px solid #eee;
    }
    th {
      background: var(--color-primary-dark);
      color: var(--color-text-light);
      font-weight: 600;
      font-size: 0.9em;
      text-transform: uppercase;
    }
    button {
      padding: 8px 14px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      transition: background 0.2s, transform 0.1s;
      margin-right: 5px;
      font-size: 0.9em;
    }
    button:active { transform: scale(0.98); }
    .confirm { background: #28a745; color: white; }
    .confirm:hover { background: #1e7e34; }
    .reject { background: #dc3545; color: white; }
    .reject:hover { background: #b02a37; }

    .status-tag {
      padding: 4px 8px;
      border-radius: 4px;
      font-weight: 600;
      font-size: 0.85em;
      display: inline-block;
    }
    .status-pending { background-color: #ffc107; color: #333; }
    .status-success { background-color: #28a745; color: white; }

    @media (max-width: 600px) {
      .header .title { display: none; }
      .header .user-info span { display: none; }
      .header { padding: 10px 15px; }
      .main-content { padding: 0 15px; }
    }
  </style>
</head>
<body>
  <div class="header">
    <div class="logo">
      <a href="admin.html">ADMIN PANEL</a>
      <span class="title">Quản lý Thanh toán</span>
    </div>
    <div class="user-info">
      <span id="welcome-message">Xin chào, Admin!</span>
      <button class="logout-btn" onclick="logout()">Đăng Xuất</button>
    </div>
  </div>

  <div class="main-content">
    <h2>Quản lý thanh toán</h2>
    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th>Mã GD</th>
            <th>Người dùng</th>
            <th>Số tiền</th>
            <th>Trạng thái</th>
            <th>Hành động</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <script>
    // JS logic từ phần trên
    async function loadOrders() {
        try {
        const res = await fetch("http://localhost:8000/v1/orders?status=waiting_admin_confirm", {
            headers: {
                "Authorization": "Bearer " + localStorage.getItem("accessToken")
            },
            credentials: "include"
        });

        if (!res.ok) throw new Error("Không thể tải đơn hàng");

        const orders = await res.json();
        const tableBody = document.querySelector("tbody");
        tableBody.innerHTML = ""; // Xoá các dòng cũ

        if (orders.length === 0) {
            tableBody.innerHTML = `<tr><td colspan="5">Không có đơn hàng chờ xác nhận.</td></tr>`;
            return;
        }

        orders.forEach(order => {
            const row = document.createElement("tr");
            row.innerHTML = `
                <td>${order._id}</td>
                <td>${order.user?.fullname || 'Không rõ'}</td>
                <td>₫${order.total.toLocaleString()}</td>
                <td><span class="status-tag status-pending">Chờ xác nhận</span></td>
                <td>
                    <button class="confirm" onclick="handleAction('confirm', '${order._id}')">Xác nhận</button>
                    <button class="reject" onclick="handleAction('reject', '${order._id}')">Từ chối</button>
                </td>
            `;
            tableBody.appendChild(row);
        });
    } catch (err) {
        console.error(err);
        alert("Lỗi khi tải đơn hàng");
    }
    }
    async function handleAction(actionType, orderId) {
        const confirmMsg = actionType === 'confirm' ? 'XÁC NHẬN' : 'TỪ CHỐI';
    if (!confirm(`Bạn có chắc chắn muốn ${confirmMsg} đơn hàng ${orderId}?`)) return;

    try {
        const res = await fetch(`http://localhost:8000/v1/orders/${orderId}/admin-action`, {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "Authorization": "Bearer " + localStorage.getItem("accessToken")
            },
            credentials: "include",
            body: JSON.stringify({ action: actionType })
        });

        if (!res.ok) {
            const data = await res.json();
            alert(data.message || "Thao tác thất bại");
            return;
        }

        alert(`Đã ${actionType === 'confirm' ? 'xác nhận' : 'từ chối'} đơn hàng thành công.`);
        loadOrders(); // reload danh sách sau khi xử lý
    } catch (err) {
        console.error(err);
        alert("Có lỗi xảy ra khi xử lý đơn hàng");
    }
    }

    function logout() {
      if (confirm("Bạn có muốn đăng xuất không?")) {
        localStorage.removeItem("accessToken");
        location.href = "./login.html"; // sửa theo đường dẫn của bạn
      }
    }

    window.onload = function() {
      loadOrders();
      const userName = localStorage.getItem('username') || 'Admin';
      const welcomeElement = document.getElementById('welcome-message');
      if (welcomeElement) {
        welcomeElement.innerText = `Xin chào, ${userName}!`;
      }
    };
  </script>
</body>
</html>
